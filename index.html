<!DOCTYPE html>
<html>
  <head>
    <title>My A-Frame Labyrinth Scene</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.7/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <a-scene background="color: #000000">
      <a-assets>
        <a-asset-item id="labyrinthe" src="./assets/labyrinthe.glb"></a-asset-item>
        <a-asset-item id="navmesh" src="./assets/labyrinthe-navmesh.glb"></a-asset-item>
        <a-asset-item id="navmesh2" src="./assets/labyrinthe-navmesh2.glb"></a-asset-item>
        <a-asset-item id="navmesh3" src="./assets/labyrinthe-navmesh3.glb"></a-asset-item>
        <a-asset-item id="mur" src="./assets/labyrinthe-mur.glb"></a-asset-item>
        <a-asset-item id="mur2" src="./assets/labyrinthe-mur.glb"></a-asset-item>
        <img id="affiche" src="./assets/affiche.png">
      </a-assets>

      <a-entity id="rig" movement-controls="constrainToNavMesh: true;" dynamic-body>
        <a-entity
          camera
          position="0 1 0"
          look-controls="pointerLockEnabled: false">
          <a-cursor></a-cursor>
          
          <!-- Le timer -->
          <a-entity
            id="timer"
            text="value: 05:00; color: white; align: center; width: 1"
            position="0.7 0.1 -1.2"
            visible="false">
          </a-entity>

          <!-- Compteur d'items collectés -->
          <a-entity
            id="item-counter"
            text="value: Chercher 3 affiches dans le labyrinthe pour sortir; color: white; align: center;"
            position="-0.5 0.1 -1.2"
            visible="true">
          </a-entity>
        </a-entity>

        <a-entity
          oculus-touch-controls="hand: left"
          laser-controls="hand: right"
          raycaster="objects: .collidable, .clickable; showline: true; far: 10"
          line="color: red">
        </a-entity>

        <a-entity
          oculus-touch-controls="hand: right"
          laser-controls="hand: left"
          raycaster="objects: .collidable, .clickable; showline: true; far: 10"
          line="color: red">
        </a-entity>
      </a-entity>

      <!-- Modèle du labyrinthe -->
      <a-entity 
        gltf-model="#labyrinthe" 
        position="0 0 -50" 
        rotation="0 90 0" 
        scale="3 3 3">
      </a-entity>

      <!-- Nav mesh pour la navigation -->
      <a-entity
        id="navmesh-entity"
        nav-mesh
        normal-material
        visible="true"
        position=".036 0.03 -50"
        rotation="0 90 0"
        scale="3 3 3"
        gltf-model="#navmesh">
      </a-entity>

      <!-- Items collectables -->
      <a-entity id="item1" geometry="primitive: plane; height: 1; width: 1" material="src: #affiche" position="0 1 -24.754" class="collectable"></a-entity>
      <a-entity id="item2" geometry="primitive: plane; height: 1; width: 1" material="src: #affiche" position="2 1 -24.754" class="collectable"></a-entity>
      <a-entity id="item3" geometry="primitive: plane; height: 1; width: 1" material="src: #affiche" position="4 1 -24.754" class="collectable"></a-entity>

      <script>
        let timerInterval;
        let itemsCollected = 0;
        let mur2;

        AFRAME.registerComponent('start-timer', {
          init: function () {
            const timer = document.querySelector('#timer');
            let timeRemaining = 300; // Pour mettre 5min

            function updateTimerDisplay() {
              const minutes = Math.floor(timeRemaining / 60);
              const seconds = timeRemaining % 60;
              timer.setAttribute('text', `value: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
            }

            timer.setAttribute('visible', true);
            const interval = setInterval(() => {
              if (timeRemaining > 0) {
                timeRemaining -= 1;
                updateTimerDisplay();
              } else {
                clearInterval(interval);
                timer.setAttribute('visible', false);
                alert('Temps &eacute;coul&eacute; !');
              }
            }, 1000);
          }
        });

        AFRAME.registerComponent('collect-item', {
          init: function () {
            const el = this.el;
            const itemCounter = document.querySelector('#item-counter');

            el.addEventListener('click', () => {
              itemsCollected += 1;
              let itemText = '';
              const navmeshEntity = document.querySelector('#navmesh-entity');
              if (itemsCollected === 1) {
                itemText = `${itemsCollected} affiche récoltée sur 3`;
                // Créer et ajouter le mur à la scène
                const scene = document.querySelector('a-scene');
                const mur = document.createElement('a-entity');
                mur.setAttribute('gltf-model', '#mur');
                mur.setAttribute('position', '0 0 30.12');
                mur.setAttribute('scale', '3 3 3');
                mur.setAttribute('rotation', '0 -90 0');
                scene.appendChild(mur);
                // Créer et ajouter le deuxième mur à la scène
                mur2 = document.createElement('a-entity');
                mur2.setAttribute('gltf-model', '#mur2');
                mur2.setAttribute('position', '-17.942 0 -38.892');
                mur2.setAttribute('scale', '3 3 3');
                mur2.setAttribute('rotation', '0 -90 0');
                scene.appendChild(mur2);
                // Changer le navmesh pour utiliser navmesh3
                navmeshEntity.setAttribute('gltf-model', '#navmesh3');
              } else if (itemsCollected === 3) {
                itemText = `Vous avez les trois affiches, vous pouvez maintenant sortir`;
                // Changer le navmesh pour utiliser navmesh2
                navmeshEntity.setAttribute('gltf-model', '#navmesh2');
                // Supprimer le deuxième mur
                mur2.parentNode.removeChild(mur2);
              } else {
                itemText = `${itemsCollected} affiches récoltées sur 3`;
              }
              itemCounter.setAttribute('text', `value: ${itemText}`);
              el.parentNode.removeChild(el);
              console.log(`Item collected. Total items: ${itemsCollected}`);
            });
          }
        });

        document.querySelectorAll('.collectable').forEach(item => {
          item.setAttribute('collect-item', '');
        });

        document.querySelector('a-scene').setAttribute('start-timer', '');
      </script>

    </a-scene>
  </body>
</html>